name: üì¶ Build Kivy APK

on:
  push:
    branches:
      - main  # –ó–∞–ø—É—Å–∫ –Ω–∞ –ø—É—à –≤ main
  pull_request:
    branches:
      - main  # –ó–∞–ø—É—Å–∫ –Ω–∞ PR –≤ main
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Å–±–æ—Ä–∫–∏
        run: |
          sudo apt update
          sudo apt install -y autoconf automake libtool libtool-bin \
                              build-essential python3-dev \
                              unzip zip libffi-dev libssl-dev \
                              libglu1-mesa libgles2-mesa \
                              python3-venv python3-pip \
                              openjdk-17-jdk

      - name: üîß –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
        run: |
          rm -rf aclocal.m4 autom4te.cache config.h.in config.sub config.guess configure ltmain.sh || true
          autoreconf --install --force

      - name: üèóÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python-–æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install cython buildozer

      - name: üîΩ –ó–∞–≥—Ä—É–∑–∫–∞ Android SDK, NDK –∏ Buildozer
        run: |
          buildozer init
          buildozer android clean
          buildozer android update

      - name: üöÄ –°–±–æ—Ä–∫–∞ APK —á–µ—Ä–µ–∑ Buildozer
        run: |
          source venv/bin/activate
          buildozer -v android debug

      - name: üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ APK
        run: |
          ls -lh bin/ || echo "–§–∞–π–ª APK –Ω–µ –Ω–∞–π–¥–µ–Ω"

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: my-app-apk
          path: bin/*.apk
          retention-days: 7  # –•—Ä–∞–Ω–∏—Ç—å APK 7 –¥–Ω–µ–π
